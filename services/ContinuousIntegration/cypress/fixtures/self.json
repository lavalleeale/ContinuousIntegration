{
  "containers": [
    {
      "id": "assets",
      "image": "base",
      "steps": [
        "yarn --cwd services/ContinuousIntegration --immutable",
        "yarn --cwd services/ContinuousIntegration build"
      ],
      "uploads": [
        "/repo/services/ContinuousIntegration/assets/output"
      ]
    },
    {
      "id": "main",
      "image": "base",
      "steps": [
        "cp -a /neededFiles/output services/ContinuousIntegration/assets/output",
        "go build -C services/ContinuousIntegration"
      ],
      "neededFiles": [
        "assets:/repo/services/ContinuousIntegration/assets/output"
      ],
      "needs": [
        "assets"
      ],
      "uploads": [
        "/repo/services/ContinuousIntegration/ContinuousIntegration"
      ]
    },
    {
      "id": "registry",
      "image": "base",
      "steps": [
        "(dockerd > dockerlog.txt 2>&1 &) && sleep 5",
        "docker buildx create --driver docker-container --name mybuilder --use --bootstrap",
        "docker cp /usr/local/share/ca-certificates/registry.crt buildx_buildkit_mybuilder0:/usr/local/share/ca-certificates/registry.crt",
        "docker exec buildx_buildkit_mybuilder0 update-ca-certificates",
        "docker login --username=$DOCKER_USER --password=$DOCKER_PASS $REGISTRY",
        "docker buildx build --tag $REGISTRY/alex/registry --cache-to=type=registry,ref=$REGISTRY/alex/registry:CI,mode=max --cache-from=type=registry,ref=$REGISTRY/alex/registry:CI --push . -f Dockerfile.registry"
      ]
    },
    {
      "id": "test",
      "image": "base",
      "steps": [
        "cp /neededFiles/ContinuousIntegration services/ContinuousIntegration/ContinuousIntegration",
        "(dockerd > dockerlog.txt 2>&1 &)",
        "echo \"RE9NQUlOPWxvY2FsaG9zdApKV1RfU0VDUkVUPWRldmVsb3BtZW50CkRPQ0tFUl9IT1NUPWxvY2FsCkRBVEFCQVNFX1VSTD1wb3N0Z3JlczovL2RldmVsb3BtZW50OmRldmVsb3BtZW50QHNlcnZpY2U6NTQzMi9kZXZlbG9wbWVudD9zc2xtb2RlPWRpc2FibGUKUlVOVElNRT1ydW5jClJFR0lTVFJZX1VSTD0iMS4xLjEuMSI=\" | base64 -d > services/ContinuousIntegration/.env",
        "yarn --cwd services/ContinuousIntegration --immutable",
        "docker buildx create --driver docker-container --name mybuilder --use --bootstrap",
        "docker cp /usr/local/share/ca-certificates/registry.crt buildx_buildkit_mybuilder0:/usr/local/share/ca-certificates/registry.crt",
        "docker exec buildx_buildkit_mybuilder0 update-ca-certificates",
        "docker login --username=$DOCKER_USER --password=$DOCKER_PASS $REGISTRY",
        "docker buildx build --tag base --cache-to=type=registry,ref=$REGISTRY/alex/base:CI,mode=max --cache-from=type=registry,ref=$REGISTRY/alex/base:CI --load images/base",
        "yarn --cwd services/ContinuousIntegration conc --kill-others --names \"server,cypress\" --success \"command-cypress\" \"./ContinuousIntegration\" \"yarn cypress run -s cypress/e2e/basic.cy.ts\"",
        "docker tag base $REGISTRY/alex/base",
        "docker push $REGISTRY/alex/base"
      ],
      "needs": [
        "main",
        "registry"
      ],
      "neededFiles": [
        "main:/repo/services/ContinuousIntegration/ContinuousIntegration"
      ],
      "service": {
        "image": "postgres",
        "healthcheck": "pg_isready",
        "environment": [
          {
            "POSTGRES_PASSWORD": "development"
          },
          {
            "POSTGRES_USER": "development"
          },
          {
            "POSTGRES_DB": "development"
          }
        ]
      }
    }
  ]
}